<!doctype html>

<meta charset="utf-8">
<title>DAGRE-D3-Graph</title>

<script src="http://d3js.org/d3.v3.js"></script>
<script src="http://cpettitt.github.io/project/graphlib-dot/v0.5.2/graphlib-dot.js"></script>
<script src="http://cpettitt.github.io/project/dagre-d3/latest/dagre-d3.min.js"></script>

<style>


    .node {
        white-space: nowrap;
    }

    .node rect,
    .node circle,
    .node ellipse {
        stroke: #333;
        fill: #fff;
        stroke-width: 1.5px;
    }

    .cluster rect {
        stroke: #333;
        fill: #000;
        fill-opacity: 0.1;
        stroke-width: 1.5px;
    }

    .edgePath path.path {
        stroke: #333;
        stroke-width: 1.5px;
        fill: none;
    }

    h1, h2 {
        color: #333;
    }

    textarea {
        width: 800px;
    }

    label {
        margin-top: 1em;
        display: block;
    }

    .error {
        color: red;
    }

    svg {
        display:block; border:0px solid #ccc; position:absolute;
        top:50px; left:0%; width:100%; height:90%; background:#eee;
    }
    g {
        border:0px solid #ccc; background:#fff;
    }
    .buttons {
        position: absolute;
        right: 20px;
        top: 15px;
    }
</style>



<body onLoad="go();">

    <div class="buttons">
        <button onclick="reset()">Reset</button>
        <button onclick="zi()" >Zoom In</button>
        <button onclick="zo()" >Zoom Out</button>
    </div>
    <svg>
    <g/>
    </svg>

    <script>
        window.onresize = function (event) {
            var oldWidth = width;
            var oldHeight = height;
            width = window.innerWidth - margin.left - margin.right;
            height = window.innerHeight - margin.top - margin.bottom;
            x = d3.scale.linear()
                    .domain([-width / 2, width / 2])
                    .range([0, width]);

            y = d3.scale.linear()
                    .domain([-height / 2, height / 2])
                    .range([height, 0]);

            graphPosX = graphPosX + (width - oldWidth) / 2;
            graphPosY = graphPosY + (height - oldHeight) / 2;
            translator(graphPosX, graphPosY, true)
        };
        var inputGraph = 'digraph {"XXX 205 316/0" ;      "Barmen 205 706/0" ;   "Barmen 205 316/0" -> "Barmen 205 706/0" ; }';
        var oldInputGraphValue;
        var graphWidth;
        var graphHeight;
//        
        var zoomlevel = 1.0;
//        var margin = {top: 20, right: 20, bottom: 20, left: 20};
        var margin = {top: 50, right: 50, bottom: 50, left: 50};
        var width = window.innerWidth - margin.left - margin.right;
        var height = window.innerHeight - margin.top - margin.bottom;

        var graphPosX, graphPosY;
        var x = d3.scale.linear()
                .domain([-width / 2, width / 2])
                .range([0, width]);

        var y = d3.scale.linear()
                .domain([-height / 2, height / 2])
                .range([height, 0]);


        // Set up zoom support
        var svg = d3.select("svg");
        var inner = d3.select("svg g");

        var zoom = d3.behavior.zoom()
                .x(x)
                .y(y)
                .center([width / 2, height / 2])
                .size([width, height])
                .on("zoom", function () {
                    inner.attr("transform", "translate(" + d3.event.translate + ")" +
                            "scale(" + d3.event.scale + ")");
                    zoomlevel = d3.event.scale;
                });


        svg.call(zoom);

//svg.on("mousedown.zoom", null);
//svg.on("mousemove.zoom", null);
//svg.on("dblclick.zoom", null);
//svg.on("touchstart.zoom", null);
svg.on("wheel.zoom", null);
svg.on("mousewheel.zoom", null);
//svg.on("MozMousePixelScroll.zoom", null);

// Create and configure the renderer
        var render = dagreD3.render();

        function go() {
            //draw('digraph {"Barmen 205 316/0" ;      "Barmen 205 706/0" ;   "Barmen 205 316/0" -> "Barmen 205 706/0" ; }');
            draw('digraph G {"Barmen 201 250/0" ;	"Barmen 200 316/0";	"Barmen 201 252/0" ;	"Barmen 205 688/0" ;	"pseudo Schluessel18746" [label=""];	"Barmen 206 132/0" ;	"Barmen 201 251/0" ;	"Barmen 205 688/0" -> "pseudo Schluessel18746" ;	"pseudo Schluessel18746" -> "Barmen 201 251/0" ;	"pseudo Schluessel18746" -> "Barmen 206 132/0";	"pseudo Schluessel18746" -> "Barmen 201 250/0" ;	"pseudo Schluessel18746" -> "Barmen 201 252/0" ;	"pseudo Schluessel18746" -> "Barmen 200 316/0" ;}');
        }

        function zoomed() {
            console.log("zoomed")

        }
        function draw(graph) {
            inputGraph = graph;
            tryDraw();
        }


        function tryDraw() {
            var g;
            if (oldInputGraphValue !== inputGraph) {
                oldInputGraphValue = inputGraph;
                try {
                    g = graphlibDot.read(inputGraph);
                } catch (e) {
                    console.log("AMOK");
                    throw e;
                }


                // Set margins, if not present
                if (!g.graph().hasOwnProperty("marginx") &&
                        !g.graph().hasOwnProperty("marginy")) {
                    g.graph().marginx = 20;
                    g.graph().marginy = 20;
                }

                g.graph().transition = function (selection) {
                    return selection.transition().duration(500);
                };



                // Render the graph into svg g
                d3.select("svg g").call(render, g);
                graphWidth = d3.select("svg g").node().getBoundingClientRect().width;
                graphHeight = d3.select("svg g").node().getBoundingClientRect().height;
                console.log(graphWidth);
                console.log(graphHeight);

                reset();
            }
        }

        function reset() {
            scaler(1, false);
            translator((width - graphWidth) / 2, (height - graphHeight) / 2, true)
        }
        function zi() {
            zoomlevel = zoomlevel * Math.pow(2, 0.4);
            adjust();
        }

        function zo() {
            zoomlevel = zoomlevel * Math.pow(2, -0.4);
            adjust();
        }

        function adjust() {
            var center0 = zoom.center();
            var translate0 = zoom.translate();
            var coordinates0 = coordinates(center0);
            scaler(zoomlevel, false);
            var center1 = point(coordinates0);
            translator(translate0[0] + center0[0] - center1[0], translate0[1] + center0[1] - center1[1], true);
        }

        function translator(x, y, withEvent) {
            graphPosX = x;
            graphPosY = y;
            if (withEvent) {
                zoom.translate([graphPosX, graphPosY]).event(svg);
            } else {
                zoom.translate([graphPosX, graphPosY]);
            }
        }
        function scaler(z, withEvent) {
            zoomlevel = z;
            if (withEvent) {
                zoom.scale(zoomlevel).event(svg);
            } else {
                zoom.scale(zoomlevel);
            }
        }

        function coordinates(point) {
            var scale = zoom.scale(), translate = zoom.translate();
            return [(point[0] - translate[0]) / scale, (point[1] - translate[1]) / scale];
        }

        function point(coordinates) {
            var scale = zoom.scale(), translate = zoom.translate();
            return [coordinates[0] * scale + translate[0], coordinates[1] * scale + translate[1]];
        }


    </script>
